---
title: "Triangulation report"
output:
 html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# Causal inference and interpretation report

It is often difficult to draw conclusions about causal relationships from observational data. We expect each individual analysis to be biased in some way, so we cannot be confident that the effect estimate generated by the analysis reflects a true causal effect.

However, there are some methods that can be applied to strengthen causal inference from observational data. Although all of these methods will be biased to some extent, some of them have different and unrelated sources of bias. Therefore, if we examine the same causal question by applying multiple methods and then comparing (or *triangulating*) the results, we can be more confident that a causal relationship does (or does not) exist.

```{r, echo=FALSE, results='asis'}
library(ggplot2)
df <- global_data$data$all_res

print(names(global_data))
print(names(global_data$triangulation_summaries))
print(lapply(global_data$triangulation_summaries,dim))

# dat <- readRDS("~/OneDrive - University of Exeter/Projects/EPoCH/EPoCH results app/data/rds/all_results_reduced.rds")
# expclass <- "caffeine consumption"
# parent <-"partner"
# outc <-"hdl cholesterol"
# df <- dat

expclass <- tolower(input$exposure_class_tri)
parent <- tolower(input$exposure_person_tri)
outc <- tolower(input$outcome_subclass2_tri)

outctype <- tolower(df$outcome_type[tolower(df$outcome_subclass2)==tolower(outc)][1])


if(expclass=="smoking"){
  expsubclass <- "active smoking"
  exptime <- "ever in pregnancy"
  exptype <-"binary"
}

if(expclass=="alcohol consumption"){
  expsubclass <- "any drinking"
  exptime <- "ever in pregnancy"
  exptype <- "binary"
}

if(expclass == "caffeine consumption"){
  expsubclass <- "any source"
  exptime <- "second trimester" #as a proxy for ever in pregnancy, chosen because it had the most amount of data and it's in the middle of preg so likely to reflect what happened in the first and third trimester
  exptype <- "continuous"
}

# calculate LCI, UCI and change to OR scale if necessary
df$lci <- df$est - (df$se * 1.96)
df$uci <- df$est + (df$se * 1.96)
if(outctype == "binary"){
  df$est <- exp(df$est)
  df$lci <- exp(df$lci)
  df$uci <- exp(df$uci)
}

# set up factors
df$mutualadj <- ifelse(grepl("1a|2a|3a|4a",df$model),"unadjusted for\nco-parent's exposure","adjusted for\nco-parent's exposure")
df$modelnumber <- NA
df$modelnumber[grepl("model1",df$model)]<-"Minimal"
df$modelnumber[grepl("model2",df$model)]<-"Standard"
df$modelnumber[grepl("model3",df$model)]<-"Standard + previous timepoints"
df$modelnumber[grepl("model4",df$model)]<-"Standard + mediators"

df$outcome_time <- factor(df$outcome_time, ordered=T, levels=c("delivery","first year","age 1 to 2","age 3 to 4","age 5 to 7", "age 8 to 11","any time in childhood"))

df$mutual_parent <- NA
df$mutual_parent[df$mutualadj=="unadjusted for\nco-parent's exposure" & df$person_exposed=="mother"]<-"mother (no mutual adj)"
df$mutual_parent[df$mutualadj=="adjusted for\nco-parent's exposure" & df$person_exposed=="mother"]<-"mother (mutual adj)"
df$mutual_parent[df$mutualadj=="unadjusted for\nco-parent's exposure" & df$person_exposed=="partner"]<-"partner (no mutual adj)"
df$mutual_parent[df$mutualadj=="adjusted for\nco-parent's exposure" & df$person_exposed=="partner"]<-"partner (mutual adj)"
df$mutual_parent <- droplevels(factor(df$mutual_parent,ordered=T,levels=c("mother (no mutual adj)","mother (mutual adj)","partner (no mutual adj)","partner (mutual adj)")))

df$exposure_time <- factor(df$exposure_time,ordered=T,levels=c("at study recruitment","initiation","age at initiation","heaviness","cessation","alcohol","caffeine","early onset","ever in life","preconception","ever in pregnancy","first trimester","second trimester","third trimester", "first two postnatal years"))

df$modelname <- ifelse(df$model=="model2b","Without adjustment for exposure\nin previous time-point","With adjustment for exposure\nin previous time-point")
df$modelname <- factor(df$modelname,ordered=T,levels=c("Without adjustment for exposure\nin previous time-point","With adjustment for exposure\nin previous time-point"))

df$exposure_dose <- factor(df$exposure_dose,ordered=T,levels=c("light","moderate","heavy"))

df$mutual_model <- NA
df$mutual_model[grepl("model2a",df$model)] <- "Unadj for co-parent's GRS\n+ unadj for child's GRS"
df$mutual_model[grepl("model2b",df$model)] <- "Adj for co-parent's GRS\n+ unadj for child's GRS"
df$mutual_model[grepl("model4a",df$model)] <- "Unadj for co-parent's GRS\n+ adj for child's GRS"
df$mutual_model[grepl("model4b",df$model)] <- "Adj for co-parent's GRS\n+ adj for child's GRS"

df$exposure_dose2 <- as.character(df$exposure_dose)
df$exposure_dose2[df$exposure_type=="binary"]<-"any"
df$exposure_dose2[df$exposure_type=="continuous"]<-"continuous"
df$exposure_dose2 <- factor(df$exposure_dose2,ordered=T,levels=c("continuous","any","light","moderate","heavy"))

df$exposure_time_sep <- as.character(df$exposure_time)
df$exposure_time_sep[df$exposure_time_sep=="at study recruitment"] <- df$exposure_subclass[df$exposure_time_sep=="at study recruitment"]
df$exposure_time_sep <- factor(df$exposure_time_sep,ordered=T,levels=c("early onset","ever in life","ever in pregnancy", "preconception","first trimester","second trimester","third trimester", "first two postnatal years", "low SEP (occupation)", "low SEP (education)"))

#set null value and x axis title for plots based on data type of the outcome
null <- 1
xtitle <- "odds ratio"
if(outctype=="continuous"){
  null <- 0
  xtitle <- "standardised mean difference"
}

```

### Evidence included in this report

This report provides evidence from the following types of analysis (depending on data availability):

-   [Multivariable regression of the exposure any time in pregnancy]

-   [Maternal vs partner comparisons]

-   [Genetic risk scores]

-   [Temporal specificity (timing of exposure)](#temporal-specificity-timing-of-exposure)

-   [Dose-response]

This report also gives a little more information to provide further help in interpreting relationships. This further information will not necessarily tell us anything more about causality, but it can help us understand and contextualise the findings.

-   [Different exposure definitions]

-   [Comparison to socioeconomic position]

## The relationship of interest

This report considers:

-   **Exposure class:** `r expclass` during pregnancy
-   **Exposed parent:** `r parent`
-   **Child's outcome:** `r outc`

**Underlying causal hypothesis:** The underlying causal hypothesis is that the `r parent`'s exposure (`r expclass`) during pregnancy causally affects the child's outcome (`r outc`).

**Target trial:** We often rely on observational data because it would be impractical or unethical to conduct an experiment (trial). However, it can be useful to define the design of a hypothetical trial. If we were studying this hypothesis using a randomised trial design, we would recruit participants who do not engage in each behaviour pre-pregnancy (i.e. unexposed pre-pregnancy) and randomise some `r parent`s to be 'exposed' (e.g. smoke, consume alcohol, or consume caffeine) for the entire pregnancy and some `r parent`s to remain unexposed (i.e. to not engage in those health behaviours at all during pregnancy). Then we would compare the outcome of interest in the children of the exposed and unexposed `r parent`s.

## Triangulation summary
```{r, echo=FALSE, results='asis', suppress=T, fig.width=9}

# ggplot(droplevels(triang_sum[triang_sum$exposure==expclass&grepl(tolower(triang_sum$outcome),pattern=outc),]),
#        aes(x=variable2,y=outcome_subclass))+
#    geom_tile(aes(fill=factor(value)))
# 
# plot_ly(triang_sum,x= ~variable2, y= ~outcome_subclass, z= ~as.numeric(value), type="heatmap")
# 
# my_strips <- strip_nested(
#   # Horizontal strips
#   text_x = elem_list_text(colour = c("black", "black","white"),size=c(10,10,1)),
#   by_layer_x = TRUE
# )
# ggplot(droplevels(triang_sum[triang_sum$exposure==expclass&grepl(tolower(triang_sum$outcome),pattern=outc),]),aes(x=variable2,y=outcome_subclass))+
#   geom_tile(aes(fill=factor(value)))+
#   scale_fill_manual(values = cols,na.translate=F)+
#   facet_nested(outcome_class~parent+T,scales = "free",space="free",strip = my_strips)+
#   theme_minimal()+
#   guides(colour="none",fill = guide_legend(byrow = TRUE))+
#   theme(axis.text=element_text(size=8),axis.title=element_blank(),
#         panel.spacing.y = unit(0.1, "lines"),
#         panel.spacing.x = unit(c(0.1,0.3,0.1), "lines"),
#         panel.grid.major.x=element_blank(),
#         panel.grid.major.y=element_line(linewidth=0.2),
#         strip.text.y=element_text(size=0),
#         strip.text.x=element_text(margin=margin(b=0,t=0)),
#         legend.title=element_blank(),legend.text=element_text(size=8),
#         legend.key.spacing.y = unit(1.5, "lines"),
#         legend.margin=margin(0,0,0,0),
#         legend.box.spacing = unit(0, "pt"))


```

## Multivariable regression of the exposure any time in pregnancy

**Rationale:** Adjusting for measured potential confounders in multivariable regression models can help to reduce bias from confounding.

**Assumptions:** No residual confounding, no selection of participants that induces spurious associations, any misclassification of exposure is not related to the outcome (and vice versa), misclassification of covariates are not systematically related to the exposure or outcome.

**A priori sources of bias:** Measurement error in exposure, measurement error in outcome, unmeasured (or residual) confounding, misclassification of exposure/outcome related to the outcome/exposure, differential missing data between exposure levels due to loss to follow-up.

**Expected direction of bias if confounded by SEP:** Estimates are most likely biased *away from* the null (i.e., if there is a true effect, the magnitude is likely to be exaggerated in these results).

**Possible insights from the plot below:** The plot shows the effect estimates (from the meta-analysis where more than one cohort contributed data) for the relationship between the exposure ever during pregnancy and the outcome, with different sets of variables adjusted for in the models. If the expected direction of bias is correct, estimates will move towards the null as more variables are included in the model (i.e., as confounding is reduced). However, sometimes adjusting for variables that are on the causal pathway between an exposure and an outcome (i.e. *mediators*) can introduce *collider bias* that can bias estimates away from the null, so estimates for models adjusted for mediators may not fit this pattern.

```{r, echo=FALSE, results='asis', suppress=T, fig.width=9}

# MVR with different adjustment sets:

bdf <- df[which(df$exposure_class==expclass &
                  df$exposure_subclass == expsubclass &
                  df$person_exposed %in% c("mother","partner") &
                  df$exposure_type == exptype &
                  tolower(tolower(df$outcome_subclass2))==tolower(outc)&
                  df$outcome_type==outctype),]
bdf <- bdf[-grep("FEMALE|MALE",bdf$model),]

bdf <- bdf[which(bdf$exposure_time==exptime),]

mvr_df <- droplevels(bdf[bdf$person_exposed == parent,])

if(nrow(mvr_df)!=0){

tri_mvr <- ggplot2::ggplot(mvr_df,aes(x=est,y=mutualadj,shape=mutualadj,xmin=lci,xmax=uci))+
  geom_pointrange(fill="white",colour="#7570b3")+
  geom_vline(xintercept = null, colour="grey50",linetype=2)+
  xlab(xtitle)+
  ylab("")+
  scale_shape_manual(values=c(22,15),limits=c("unadjusted for\nco-parent's exposure","adjusted for\nco-parent's exposure"))+
  facet_grid(modelnumber~outcome_time,labeller = labeller(grp = label_wrap_gen(width = 25)))+
  theme_classic()+
  theme(legend.position = "none",strip.text.y = element_text(angle = 0))

if(outctype=="binary"){
  tri_mvr <- tri_mvr+coord_trans("log10")+scale_x_continuous(breaks = seq(0,max(mvr_df$uci,na.rm = T),1) )
}

tmp1 <- mvr_df[,c("mutualadj","outcome_time","modelnumber")]
tmp1$value <- as.character(mvr_df$total_n)
tmp1$variable <- "Total N"
tmp2 <- mvr_df[,c("mutualadj","outcome_time","modelnumber")]
tmp2$value <- as.character(mvr_df$cohorts)
tmp2$variable <- "Cohorts"
mvr_df_n <- rbind(tmp1,tmp2)

tri_mvr_n <- ggplot2::ggplot(mvr_df_n,aes(x=cohort,y=mutualadj))+
   geom_text(aes(x=1,label=value),hjust=0.5,size=3,position = position_dodge2(width=0.5))+
  xlab("")+
  ylab("")+
  facet_grid(modelnumber~outcome_time,labeller = labeller(grp = label_wrap_gen(width = 25)))+ #possible improvement using ggh4x facet_nested: https://stackoverflow.com/questions/62652308/combine-multiple-facet-strips-across-columns-in-ggplot2-facet-wrap
  theme_classic()+
  theme(axis.ticks.x=element_blank(),axis.text.x=element_blank(),legend.position = "none",strip.text.y = element_text(angle = 0))

res_list <- list(tri_mvr,tri_mvr_n)
for(i in seq_along(res_list)){ print(res_list[[i]]) }


}else{
  cat('<span style="color: #D95F02;">Sorry, there is insufficent data to generate the plot</span>')

} 



```

## Maternal vs partner comparisons

**Rationale:** Parents tend to live in the same household, or at least share similar environments. They may also share other characteristics due to assortative mating, whereby people from similar demographics tend to form relationships with each other. Biological parents also share 50% of their genomes with their children. Therefore, exposure variables for each parent are likely to be correlated with each other, and with a set of (unmeasured and measured) 'familial' confounders. Accordingly, when estimating the effect of one parent's exposure, independent of the co-parent's exposure, it is important to adjust for the co-parent's exposure. In addition, when we are interested in the independent effect of the mother's exposure during pregnancy, under the hypothesis that the exposure has an intrauterine effect on the fetus, the partner's exposure can be considered as a *negative control* because it cannot plausibly affect the outcome except via an effect on the mother. In this case, after adjustment for the mother's exposure, any residual association between the partner's exposure and the outcome may be explained by residual confounding by familial confounders. By comparing mutually adjusted estimates of the maternal and partner effects, we can examine the strength of evidence for a causal maternal intrauterine effect.

**Assumptions:** The key sources of bias (specific confounders, misclassification bias and other biases) are the same (shared) for the maternal and partner exposures; there is no real caulsal effect of the partner's exposure on the outcome *operating via the same mechanism as the maternal effect*. The maternal and partner exposures are measured on the same/similar scales.

**A priori sources of bias:** The sources of bias between the maternal and partner exposure are different (i.e. they aren't shared). There is a real causal effect of the partner's exposure on the outcome that *operates via the same mechanism as the maternal effect.*

**Expected direction of bias if confounded by SEP:** Prior to mutual adjustment, estimates are most likely biased *away from* the null (i.e., if there is a true effect, the magnitude is likely to be exaggerated in these results).

**Possible insights from the plot below:** Where the estimated effect of one parent's exposure is greater than that of another, even after mutual adjustment, this suggests a potential causal effect of that parent's exposure on the outcome. Where mutually-adjusted estimates move to the null, with confidence intervals that cross the null, this suggests that the association is more likely to be explained by (residual) shared familial confounding than a true causal effect.

```{r, echo=FALSE, results='asis', fig.width=9}

# Negative control

bdf <- droplevels(bdf)

if(nrow(bdf)!=0){

tri_negcon <- ggplot2::ggplot(bdf,aes(x=est,y=mutual_parent,shape=mutual_parent,colour=mutual_parent,xmin=lci,xmax=uci))+
  geom_pointrange(position = position_dodge2(width=1),fill="white")+
  geom_vline(xintercept = null, colour="grey50",linetype=2)+
  xlab(xtitle)+
  ylab("")+
  scale_colour_manual(values=c("#d95f02","#d95f02","#1b9e77","#1b9e77"),limits=c("mother (no mutual adj)","mother (mutual adj)","partner (no mutual adj)","partner (mutual adj)"))+
  scale_shape_manual(values=c(22,15,22,15),limits=c("mother (no mutual adj)","mother (mutual adj)","partner (no mutual adj)","partner (mutual adj)"))+
  theme_classic()+
  facet_grid(modelnumber~outcome_time,labeller = labeller(grp = label_wrap_gen(width = 25)))+
  theme(legend.position = "none",strip.text.y = element_text(angle = 0))

if(outctype=="binary"){
  tri_negcon <- tri_negcon+coord_trans("log10")+scale_x_continuous(breaks = seq(0,max(bdf$uci,na.rm = T),1) )
}


tmp1 <- bdf[,c("mutual_parent","outcome_time","modelnumber")]
tmp1$value <- as.character(bdf$total_n)
tmp1$variable <- "Total N"
tmp2 <- bdf[,c("mutual_parent","outcome_time","modelnumber")]
tmp2$value <- as.character(bdf$cohorts)
tmp2$variable <- "Cohorts"
bdf_n <- rbind(tmp1,tmp2)

tri_negcon_n <- ggplot2::ggplot(bdf_n,aes(x=cohort,y=mutual_parent,colour=mutual_parent))+
  geom_text(aes(x=1,label=value),hjust=0.5,size=3,position = position_dodge2(width=0.5))+
  xlab("")+
  ylab("")+
    scale_colour_manual(values=c("#d95f02","#d95f02","#1b9e77","#1b9e77"),limits=c("mother (no mutual adj)","mother (mutual adj)","partner (no mutual adj)","partner (mutual adj)"))+
  facet_grid(modelnumber~outcome_time,labeller = labeller(grp = label_wrap_gen(width = 25)))+ 
  theme_classic()+
  theme(axis.ticks.x=element_blank(),axis.text.x=element_blank(),legend.position = "none",strip.text.y = element_text(angle = 0))


res_list <- list(tri_negcon,
tri_negcon_n)
for(i in seq_along(res_list)){ print(res_list[[i]]) }


}else{
  cat('<span style="color: #D95F02;">Sorry, there is insufficent data to generate the plot</span>')
}
```

## Genetic risk scores {data-link="Genetic risk scores"}

**Rationale:** A genetic risk score (GRS) contains several genetic variants that have been shown to robustly relate to the exposure of interest. Genetic variation is fixed at conception and therefore cannot be modified by exposures occuring after conception. This means that a GRS will be robustly associated with an exposure, but cannot be affected by factors that might confound any association between that exposure and an outcome. Therefore, a GRS can be used to 'proxy' or 'instrument' an exposure to assess its potential causal effect on an outcome while overcoming some types of confounding. This is the principle behind the Mendelian randomization approach.

**Assumptions:** There are three main assumptions: (1) Relevance: the genetic variant is associated with the exposure of interest; (2) Independence: there are no unmeasured confounders of the association between the exposure and outcome; (3) Exclusion restriction: the GRS affects the outcome *only* via its effect on the exposure.

**A priori sources of bias:** Violation of any of the three assumptions above; population stratification.

**Expected direction of bias:** Violation of the relevance assumption would introduce 'weak instrument bias', which would bias estimates towards the null. Given that parents transmit 50% of their genetic information to their children, some of the estimated effect may be driven by genetic transmission rather than a causal effect of the exposure. Therefore, without adjustment for child's GRS, the effect estimate may be overestimated away from the null. However, adjusting for child's GRS may introduce collider bias that would also push the effect estimate away from the null (and potentially in a different direction). Additionally adjusting for the other parent's GRS may help to avoid collider bias.

**Possible insights from the plot below:** Generally, the power for genetic analyses is lower than for observational analyses because the sample size with genetic data is lower and/or the GRS only partially explains the variance in the exposure. Therefore, confidence intervals are likely to be wide. However, where estimates are large and/or confidence intervals do not cross the null, there is some evidence of a causal effect.

```{r, echo=FALSE, results='asis', fig.width=9}

# GRS
gen_df <- df[which(df$exposure_class== expclass&
                      df$exposure_subclass == "genetic risk score" &
                      df$person_exposed==parent &
                      tolower(df$outcome_subclass2)==tolower(outc)&
                     df$outcome_type==outctype),]
gen_df <- droplevels(gen_df[-grep("FEMALE|MALE",gen_df$model),])

if(nrow(gen_df)!=0){
tri_grs <- ggplot2::ggplot(gen_df,aes(x=est,y=mutual_model,shape=mutual_model,colour=mutual_model,xmin=lci,xmax=uci))+
  geom_pointrange(position = position_dodge2(width=1),fill="white")+
  geom_vline(xintercept = null, colour="grey50",linetype=2)+
  xlab(xtitle)+
  ylab("")+
  theme_classic()+
  scale_colour_manual(values=c("#a6761d","#a6761d","#66a61e","#66a61e"),limits=c("Unadj for co-parent's GRS\n+ unadj for child's GRS","Adj for co-parent's GRS\n+ unadj for child's GRS","Unadj for co-parent's GRS\n+ adj for child's GRS","Adj for co-parent's GRS\n+ adj for child's GRS"))+
  scale_shape_manual(values=c(22,15,22,15),limits=c("Unadj for co-parent's GRS\n+ unadj for child's GRS","Adj for co-parent's GRS\n+ unadj for child's GRS","Unadj for co-parent's GRS\n+ adj for child's GRS","Adj for co-parent's GRS\n+ adj for child's GRS"))+
  facet_grid(exposure_time~outcome_time,labeller = labeller(grp = label_wrap_gen(width = 25)))+
  theme(legend.position = "none",strip.text.y = element_text(angle = 0))

tmp1 <- gen_df[,c("outcome_time","mutual_model","exposure_time","modelname")]
tmp1$value <- as.character(gen_df$total_n)
tmp1$variable <- "Total N"
tmp2 <- gen_df[,c("outcome_time","mutual_model","exposure_time","modelname")]
tmp2$value <- as.character(gen_df$cohorts)
tmp2$variable <- "Cohorts"
gen_df_n <- rbind(tmp1,tmp2)

tri_grs_n <- ggplot2::ggplot(gen_df_n,aes(x=cohort,y=mutual_model,colour=mutual_model))+
  geom_text(aes(x=1,label=value),hjust=0.5,size=3,position = position_dodge2(width=0.5))+
  xlab("")+
  ylab("")+
    scale_colour_manual(values=c("#a6761d","#a6761d","#66a61e","#66a61e"),limits=c("Unadj for co-parent's GRS\n+ unadj for child's GRS","Adj for co-parent's GRS\n+ unadj for child's GRS","Unadj for co-parent's GRS\n+ adj for child's GRS","Adj for co-parent's GRS\n+ adj for child's GRS"))+
  facet_grid(exposure_time~outcome_time,labeller = labeller(grp = label_wrap_gen(width = 25)),space="free_y",scales = "free_y")+
  theme_classic()+
  theme(axis.ticks.x=element_blank(),axis.text.x=element_blank(),legend.position = "none",strip.text.y = element_text(angle = 0))

if(outctype=="binary"){
  tri_grs <- tri_grs+coord_trans("log10")+scale_x_continuous(breaks = seq(0,max(gen_df$uci,na.rm = T),1) )
}


res_list <- list(tri_grs,
tri_grs_n)
for(i in seq_along(res_list)){ print(res_list[[i]]) }


}else{
  cat('<span style="color: #D95F02;">Sorry, there is insufficent data to generate the plot</span>')

}
```

## Temporal specificity (timing of exposure) {#temporal-specificity-timing-of-exposure}

**Rationale:** the biological mechanisms that explain any effect of exposures during pregnancy are likely to be different from those that explain effects of exposures pre-or post-pregnancy. For example, while exposures during pregnancy could have direct intrauterine effects on the developing fetus, pre-pregnancy exposures may influence gamete (sperm and ovum/egg) development, and post-pregnancy exposures may affect child health via parenting behaviours or more directly in the case of passive smoke exposure. If there is a causal effect of exposure during pregnancy, we would expect estimates of the effect of the exposure in pregnancy to be greater (further from the null) than estimates of the effect of the exposure pre- or post-pregnancy. There may also be sensitive or critical windows of exposure during pregnancy, for example, an exposure may causally affect an outcome *only* if it occurs in the first trimester. Comparing effect estimates for exposures measured in different trimesters, with adjustment for exposures in previous stages, can help reveal these effects.

**Assumptions:** No residual confounding, no selection of participants that induces spurious associations, any misclassification of exposure is not related to the outcome (and vice versa), misclassification of covariates are not systematically related to the exposure or outcome. In addition, these analyses also assume that exposures are measured on the same/similar scales at different time points.

**A priori sources of bias:** Measurement error in exposure, measurement error in outcome, unmeasured (or residual) confounding, misclassification of exposure/outcome related to the outcome/exposure, differential missing data between exposure levels due to loss to follow-up. In addition, exposures measured on different scales at different time points.

**Possible insights from the plot below:** If there is a sensitive/critical period, we would expect to see stronger effects (i.e. estimates further from the null) in those periods, compared to others. These observations should remain after adjustment for the exposure in a previous period.

```{r, echo=FALSE, results='asis', fig.width=9,fig.height=12}
# Timing specific
## this can tell us something about the importance of timing of exposure (e.g. critical/sensitive periods)
## it can also tell us about intrauterine causality - if the intrauterine exposure(s) are stronger than the preconception/postnatal, this suggests an intrauterine effect

time_df <- df[which(df$exposure_class== expclass&
                  df$exposure_subclass == expsubclass &
                  df$person_exposed==parent &
                  tolower(df$outcome_subclass2)==tolower(outc)&
                    df$outcome_type==outctype),]
time_df <- time_df[-grep("FEMALE|MALE",time_df$model),]

time_df <- time_df[which(time_df$exposure_time %in% c("preconception","first trimester","second trimester","third trimester", "first two postnatal years")),]
time_df <- time_df[time_df$model%in%(c("model2b","model3b")),] # main model only, with and without adjustment for previous timepoints

time_df <- droplevels(time_df[time_df$exposure_type==exptype,]) # binary

if(nrow(time_df)!=0){
tri_time <- ggplot2::ggplot(time_df,aes(x=est,y=modelname,xmin=lci,xmax=uci))+
  geom_pointrange(fill="white",colour="#7570b3",shape=15)+
  geom_vline(xintercept = null, colour="grey50",linetype=2)+
  xlab(xtitle)+
  ylab("")+
  facet_grid(exposure_time~outcome_time,labeller = labeller(grp = label_wrap_gen(width = 25)))+
  theme_classic()+
  theme(strip.text.y = element_text(angle = 0))

if(outctype=="binary"){
  tri_time <- tri_time+coord_trans("log10")+scale_x_continuous(breaks = seq(0,max(time_df$uci,na.rm = T),1) )
}


tmp1 <- time_df[,c("exposure_time","outcome_time","modelname")]
tmp1$value <- as.character(time_df$total_n)
tmp1$variable <- "Total N"
tmp2 <- time_df[,c("exposure_time","outcome_time","modelname")]
tmp2$value <- as.character(time_df$cohorts)
tmp2$variable <- "Cohorts"
time_df_n <- rbind(tmp1,tmp2)

tri_time_n <- ggplot2::ggplot(time_df_n,aes(x=cohort,y=modelname))+
  geom_text(aes(x=1,label=value),hjust=0.5,size=3,position = position_dodge2(width=0.5))+
  xlab("")+
  ylab("")+
  facet_grid(exposure_time~outcome_time,labeller = labeller(grp = label_wrap_gen(width = 25)))+
  theme_classic()+
  theme(axis.ticks.x=element_blank(),axis.text.x=element_blank(),legend.position = "none",strip.text.y = element_text(angle = 0))


res_list <- list(tri_time,
tri_time_n)
for(i in seq_along(res_list)){ print(res_list[[i]]) }


}else{
  cat('<span style="color: #D95F02;">Sorry, there is insufficent data to generate the plot</span>')

}
```

## Dose-response

**Rationale:** if there is a causal effect of an exposure on an outcome, greater levels of the exposure should be associated with a stronger effect.

**Assumptions:** No residual confounding, no selection of participants that induces spurious associations, any misclassification of exposure is not related to the outcome (and vice versa), misclassification of covariates are not systematically related to the exposure or outcome.

**A priori sources of bias:** Measurement error in exposure, measurement error in outcome, unmeasured (or residual) confounding, misclassification of exposure/outcome related to the outcome/exposure, differential missing data between exposure levels due to loss to follow-up.

**Possible insights from the plot below:** If there is a dose-response effect, the plot should show effect estimates moving away from the null as the exposure level increases.

```{r, echo=FALSE, results='asis', fig.width=9,fig.height=12}

# dose response
dose_df <- df[which(df$exposure_class== expclass&
                      df$exposure_subclass == expsubclass &
                      df$person_exposed==parent &
                      tolower(df$outcome_subclass2)==tolower(outc)&
                      df$outcome_type==outctype),]
dose_df <- dose_df[-grep("FEMALE|MALE",dose_df$model),]

dose_df <- dose_df[which(dose_df$exposure_dose %in% c("light","moderate","heavy")),]
dose_df <- droplevels(dose_df[dose_df$model%in%(c("model2b","model3b")),]) # main model only, with and without adjustment for previous timepoints

if(nrow(dose_df)!=0){

tri_dose <- ggplot2::ggplot(dose_df,aes(x=est,y=exposure_dose,xmin=lci,xmax=uci))+
    geom_pointrange(position = position_dodge2(width=1),fill="white",aes(colour=modelname, shape=modelname))+
  geom_vline(xintercept = null, colour="grey50",linetype=2)+
  xlab(xtitle)+
  ylab("")+
  facet_grid(exposure_time~outcome_time,labeller = labeller(grp = label_wrap_gen(width = 25)))+
  scale_colour_manual(values=c("#e6ab02","#e7298a"),limits=c("Without adjustment for exposure\nin previous time-point","With adjustment for exposure\nin previous time-point"))+
  scale_shape_manual(values=c(22,15),limits=c("Without adjustment for exposure\nin previous time-point","With adjustment for exposure\nin previous time-point"))+
  theme_classic()+
  theme(axis.ticks.x=element_blank(),axis.text.x=element_blank(),legend.position = "none",strip.text.y = element_text(angle = 0))


tmp1 <- dose_df[,c("outcome_time","exposure_dose","exposure_time","modelname")]
tmp1$value <- as.character(dose_df$total_n)
tmp1$variable <- "Total N"
tmp2 <- dose_df[,c("outcome_time","exposure_dose","exposure_time","modelname")]
tmp2$value <- as.character(dose_df$cohorts)
tmp2$variable <- "Cohorts"
dose_df_n <- rbind(tmp1,tmp2)

tri_dose_n <- ggplot2::ggplot(dose_df_n,aes(x=cohort,y=exposure_dose,colour=modelname))+
  geom_text(aes(x=1,label=value),hjust=0.5,size=3,position = position_dodge2(width=0.5))+
  xlab("")+
  ylab("")+
    scale_colour_manual(values=c("#e6ab02","#e7298a"),limits=c("Without adjustment for exposure\nin previous time-point","With adjustment for exposure\nin previous time-point"))+
  facet_grid(exposure_time~outcome_time,labeller = labeller(grp = label_wrap_gen(width = 25)))+
  theme_classic()+
  theme(axis.ticks.x=element_blank(),axis.text.x=element_blank(),legend.position = "none",strip.text.y = element_text(angle = 0))

if(outctype=="binary"){
  tri_dose <- tri_dose+coord_trans("log10")+scale_x_continuous(breaks = seq(0,max(dose_df$uci,na.rm = T),1) )
}


res_list <- list(tri_dose,
tri_dose_n)
for(i in seq_along(res_list)){ print(res_list[[i]]) }



}else{
  cat('<span style="color: #D95F02;">Sorry, there is insufficent data to generate the plot</span>')

}
```

## Different exposure definitions

This plot (generated if the data are available) shows how different exposure definitions (i.e., other than the main exposures of active smoking, general alcohol consumption, and caffeine consumption from any source) are related to the outcome of interest. These "different exposure definitions" include passive smoking, early onset smoking, binge drinking of alcohol, and caffeine intake from specific beverages - tea, coffee and cola.

This information provides further context to help interpret the relationship between the main exposure of interest and outcome.

```{r, echo=FALSE, results='asis', fig.width=9,fig.height=12}
# exposure subclasses (just model 2b)
## tea, coffee, cola (different confounding structures, so hints at whether caffeine or another ingredient or confounding)
## binge vs normal (drinking behaviour - not sure if this suggests anything about causality or would be better placed in the dose section)
## passive vs active (as above for drinking)

sc_df <- df[which(df$exposure_class== expclass&
                     df$person_exposed==parent &
                     tolower(df$outcome_subclass2)==tolower(outc)&
                     df$outcome_type==outctype),]
sc_df <- sc_df[-grep("FEMALE|MALE|1a|2a|3a|4a|1b|3b|4b",sc_df$model),]

if("continuous" %in% sc_df$exposure_dose2){
  sc_df <- sc_df[sc_df$exposure_dose2=="continuous",]
}

sc_df <-droplevels(sc_df)

if(length(unique(sc_df$exposure_subclass))>1){
tri_sc <- ggplot2::ggplot(sc_df,aes(x=est,y=exposure_time,xmin=lci,xmax=uci))+
  geom_pointrange(aes(colour=exposure_dose2),position = position_dodge2(width=1),shape=15)+
  geom_vline(xintercept = null, colour="grey50",linetype=2)+
  scale_color_manual(values=c("#7570b3","#a8ddb5","#7bccc4","#2b8cbe"),limits=c("any","light","moderate","heavy"))+
  xlab(xtitle)+
  ylab("")+
  theme_classic()+
  facet_grid(exposure_subclass~outcome_time,space="free_y",scales = "free_y",labeller = labeller(grp = label_wrap_gen(width = 25)))+
  theme(legend.position="bottom",legend.title = element_blank(),strip.text.y = element_text(angle = 0))

if(outctype=="binary"){
  tri_sc <- tri_sc+coord_trans("log10")+scale_x_continuous(breaks = seq(0,max(sc_df$uci,na.rm = T),1) )
}

tmp1 <- sc_df[,c("outcome_time","exposure_dose2", "exposure_subclass","exposure_time","modelname")]
tmp1$value <- as.character(sc_df$total_n)
tmp1$variable <- "Total N"
tmp2 <- sc_df[,c("outcome_time","exposure_dose2","exposure_subclass","exposure_time","modelname")]
tmp2$value <- as.character(sc_df$cohorts)
tmp2$variable <- "Cohorts"
sc_df_n <- rbind(tmp1,tmp2)

tri_sc_n <- ggplot2::ggplot(sc_df_n,aes(x=cohort,y=exposure_time,colour=exposure_dose2))+
  geom_text(aes(x=1,label=value),hjust=0.5,size=3,position = position_dodge2(width=0.5))+
  xlab("")+
  ylab("")+
    scale_color_manual(values=c("#7570b3","#a8ddb5","#7bccc4","#2b8cbe"),limits=c("any","light","moderate","heavy"))+
  facet_grid(exposure_subclass~outcome_time,labeller = labeller(grp = label_wrap_gen(width = 25)),space="free_y",scales = "free_y")+
  theme_classic()+
  theme(axis.ticks.x=element_blank(),axis.text.x=element_blank(),legend.position = "none",strip.text.y = element_text(angle = 0))


list(tri_sc,
tri_sc_n)

res_list <- list(tri_sc,
tri_sc_n)
for(i in seq_along(res_list)){ print(res_list[[i]]) }


}else{
  cat('<span style="color: #D95F02;">Sorry, there is insufficent data to generate the plot</span>')

}

```

## Comparison to socioeconomic position

Health behaviours like smoking, alcohol and caffeine consumption are often heavily socially patterned - meaning that some sociodemographics are more likely to engage in them than others. This plot (generated if the data are available) shows how measures of parental socioeconomic position (education and occupation) are related to the outcome of interest. The effect estimates are provided alongside the effect estimate for the main exposure of interest for comparison. This helps to *contextualise* the evidence. Where the effect estimate for the main exposure is similar to or closer to null than the estimate for socioeconomic position (even after adjustment for socioeconomic position), this suggests that the most effective intervention might be best targeted at the social level (e.g. to tackle health inequalities) rather than the individual.

```{r, echo=FALSE, results='asis', fig.width=9,fig.height=12}

# contextualise by comparison with SEP (minimal adjustment - 1a)

sep_df <- df[which(df$exposure_class %in% c(expclass, "low socioeconomic position") &
                    df$person_exposed==parent &
                     df$exposure_subclass %in% c(expsubclass,"low SEP (education)","low SEP (occupation)") &
                     df$exposure_type == "binary" &
                    tolower(df$outcome_subclass2)==tolower(outc)&
                    df$outcome_type==outctype),]
sep_df <- droplevels(sep_df[-grep("FEMALE|MALE|2a|3a|4a|1b|2b|3b|4b",sep_df$model),])

if("low socioeconomic position"%in%sep_df$exposure_class==T){
tri_sep <- ggplot2::ggplot(sep_df,aes(x=est,y=exposure_time_sep,xmin=lci,xmax=uci))+
  geom_pointrange(fill="white",colour="#7570b3",shape=15)+
  geom_vline(xintercept = null, colour="grey50",linetype=2)+
  xlab(xtitle)+
  ylab("")+
  theme_classic()+
  facet_grid(exposure_class~outcome_time,space="free_y",scales = "free_y",labeller = labeller(grp = label_wrap_gen(width = 25)))+
  theme(strip.text.y = element_text(angle = 0))

if(outctype=="binary"){
  tri_sep <- tri_sep+coord_trans("log10")+scale_x_continuous(breaks = seq(0,max(sep_df$uci,na.rm = T),1) )
}



tmp1 <- sep_df[,c("outcome_time","exposure_class", "exposure_time_sep","exposure_time")]
tmp1$value <- as.character(sep_df$total_n)
tmp1$variable <- "Total N"
tmp2 <- sep_df[,c("outcome_time","exposure_class", "exposure_time_sep","exposure_time")]
tmp2$value <- as.character(sep_df$cohorts)
tmp2$variable <- "Cohorts"
sep_df_n <- rbind(tmp1,tmp2)

tri_sep_n <- ggplot2::ggplot(sep_df_n,aes(x=cohort,y=exposure_time_sep))+
  geom_text(aes(x=1,label=value),hjust=0.5,size=3,position = position_dodge2(width=0.5))+
  xlab("")+
  ylab("")+
  facet_grid(exposure_class~outcome_time,space="free_y",scales = "free_y",labeller = labeller(grp = label_wrap_gen(width = 25)))+ #possible improvement using ggh4x facet_nested: https://stackoverflow.com/questions/62652308/combine-multiple-facet-strips-across-columns-in-ggplot2-facet-wrap
  theme_classic()+
  theme(axis.ticks.x=element_blank(),axis.text.x=element_blank(),legend.position = "none",strip.text.y = element_text(angle = 0))


res_list <- list(tri_sep,
tri_sep_n)
for(i in seq_along(res_list)){ print(res_list[[i]]) }



}else{
  cat('<span style="color: #D95F02;">Sorry, there is insufficent data to generate the plot</span>')

}
```
